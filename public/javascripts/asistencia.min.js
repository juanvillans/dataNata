document.addEventListener("DOMContentLoaded",function(){function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function t(e,t=!1,n){t||(r.scrollLeft=v[n].scrollLeft,r.scrollTop=v[n].scrollTop),setTimeout(()=>{const n=Date.now();_.innerHTML="",u.innerHTML="",document.getElementById("input_n_classes").value=e.nroClasses,q=e.nroClasses,document.getElementById("input_n_classes").min=e.lastAttendedDay,m=N.querySelector("#th_nro_students"),m.textContent=`${e.students.length}`;const o=N.cloneNode(!0),s=document.createDocumentFragment();s.appendChild(o);for(let t=1;t<=e.nroClasses;t++){const e=w.querySelector("label");e.title=`marcar toda la columna ${t}`,w.querySelector(".marcar_col_input").dataset.col=t-1,e.querySelector("span.text").textContent=t;const n=w.cloneNode(!0);s.appendChild(n)}const l=j.cloneNode(!0);s.append(l),u.append(s);const c=document.createDocumentFragment();if(e.students.forEach((e,t)=>{const n=I.cloneNode(!0);n.querySelector("tr").dataset.id=e._id,n.querySelector("tr").dataset.index=t,n.querySelector(".each_student_number").textContent=t+1,n.querySelector(".student_name_input").value=e.name;let o=document.createDocumentFragment();e.attendances.forEach((e,t)=>{k.querySelector(".each_cell").dataset.col=t,1==e?k.querySelector(".each_cell").classList.add("attended"):k.querySelector(".each_cell").classList.remove("attended");const n=k.cloneNode(!0);o.appendChild(n)}),n.querySelector(".each_total").before(o),a(e.total,q,n.querySelector(".each_total")),o=null,c.appendChild(n)}),_.appendChild(c),t){_.style.minWidth="5000px";const e=57*+g.lastAttendedDay;r.scrollLeft=e}const d=Date.now();console.log("Print data in : ",(d-n)/1e3)},.2)}function n(e){if(i.value>100)return window.alert("El valor no puede ser mayor a 100"),void(i.value=q);if(i.value<g.lastAttendedDay){if(!window.confirm(`No puede eliminar la columna del dia ${g.lastAttendedDay} porque hay estudiantes registrados asistentes ese dia.\n       Se eliminará hasta la columna ${g.lastAttendedDay+1} en su lugar. ¿Está de acuerdo?`))return void(i.value=q);i.value=g.lastAttendedDay}g.nroClasses=+i.value,e=+i.value;let t=e-q;if(t>0){const t=document.createDocumentFragment(),n=document.createDocumentFragment();for(let a=q;a<e;a++){const e=w.querySelector("label");e.title=`marcar toda la columna ${a+1}`,w.querySelector(".marcar_col_input").dataset.col=a,e.querySelector("span.text").textContent=a+1;const o=w.cloneNode(!0),s=k.cloneNode(!0);s.querySelector(".each_cell").dataset.col=a,t.appendChild(o),n.appendChild(s);for(let e=0;e<m.textContent;e++)g.students[e].attendances.push(0)}const o=document.querySelector("thead tr"),s=document.querySelector(".th_total");o.insertBefore(t,s),document.querySelectorAll("tr[data-id]").forEach((t,o)=>{const s=t.querySelector(".each_total");a(g.students[o].total,e,s),t.insertBefore(n.cloneNode(!0),s)})}if(t<0){const n=document.querySelectorAll(`thead tr > .th_each_colunm:nth-child(n + ${e+2})`),o=document.querySelectorAll(`tr[data-id] > .each_cell:nth-child(n + ${e+2})`);Array.from(n).forEach(e=>e.remove()),Array.from(o).forEach(e=>e.remove()),console.log({number_left:t,future_n_classes:e}),g.students.forEach((t,n)=>{t.attendances.splice(e),console.log(t),a(t.total,e,x[n])}),console.log({subjectData:g})}q=e,d(),s()}function a(e,t,n){let a=e/t*100;a=a%1==0?Math.trunc(a):a.toFixed(1);const o=n.closest("tr");n.textContent=a+"%";const s=o.querySelector(".td_student_name");return a>=75?(s.classList.add("min75"),n.classList.add("min75")):(s.classList.remove("min75"),n.classList.remove("min75")),a}function o(){const e=++document.querySelector("#th_nro_students").textContent;m.textContent++;const t=I.cloneNode(!0);g.lastIdStudent+=1,t.querySelector("tr").dataset.id=g.lastIdStudent,t.querySelector("tr").dataset.index=e-1,t.querySelector(".each_student_number").textContent=e;let n=document.createDocumentFragment();for(let e=0;e<q;e++){k.querySelector(".each_cell").dataset.col=e;const t=k.cloneNode(!0);n.appendChild(t)}t.querySelector(".each_total").before(n),_.appendChild(t),g.students.push({_id:g.lastIdStudent,name:"",attendances:new Array(q).fill(0),total:0}),_.querySelector(`tr[data-id="${g.lastIdStudent}"] .student_name_input`).focus(),s(),d()}function s(){let e=JSON.parse(JSON.stringify(g));e.scrollLeft=r.scrollLeft,e.scrollTop=r.scrollTop,b<v.length-1?(console.log(v.length-b),v.splice(b+1,v.length-b,e),f.classList.add("disabled"),console.log("esto se ejecutó")):(v.push(e),console.log("y esto tambíen")),p.classList.remove("disabled"),b>25&&v.shift(),b=v.length-1,b<1&&p.classList.add("disabled")}function l(){if(b>0){f.classList.remove("disabled"),b--,t(v[b],!1,b+1),g=JSON.parse(JSON.stringify(v[b]));const e=L.subjects.findIndex(e=>e._id==g._id);L.subjects[e]=g,d()}0==b&&p.classList.add("disabled")}function c(){p.classList.remove("disabled"),b++,t(v[b],!1,b),g=JSON.parse(JSON.stringify(v[b]));const e=L.subjects.findIndex(e=>e._id==g._id);L.subjects[e]=g,d(),b==v.length-1&&f.classList.add("disabled")}function d(){localStorage.setItem("data",JSON.stringify(L))}const r=document.querySelector(".table_container"),u=document.querySelector("thead tr"),i=document.getElementById("input_n_classes");document.querySelector(".th_total");let m="";const y=document.querySelector("main");document.querySelector(".create_student_btn");const _=document.querySelector("tbody"),p=(document.getElementsByClassName("student_name"),document.getElementById("marcar_todos"),document.querySelector(".past")),f=document.querySelector(".future"),h=(document.getElementsByClassName(".marcar_fila_input"),document.querySelector("#select_area")),S=document.querySelector(".import_student_modal");console.log({import_student_modal:S});let g={};document.getElementsByClassName("each_cell");const x=document.getElementsByClassName("each_total");document.querySelector("#edit_subject_button");let q=+i.value,v=[],b=v.length,L={},C="";const D=(e,t)=>{let n;return(...a)=>{n&&clearTimeout(n),n=setTimeout(()=>{e(...a)},t)}},E=document.querySelector("#template_option").content,A=async()=>{function e(){const e=document.createDocumentFragment();L.subjects.map(e=>({name:e.name,_id:e._id})).forEach(t=>{const n=E.cloneNode(!0);n.querySelector("option").value=t._id,n.querySelector("option").dataset.id=t._id,n.querySelector("option").textContent=t.name,e.appendChild(n)}),h.append(e),g=L.subjects[0],C=g._id,h.value=C,t(g,!0),s()}if(L=localStorage.getItem("data"),L)L=JSON.parse(L),console.log("los tados existen en el localstorage",L),e();else try{const t=await fetch("https://attend-app-rho.vercel.app/asistencias/jeje");t.ok?(L=await t.json(),console.log("Datos de la API:",L),null!=L&&(e(),localStorage.setItem("data",JSON.stringify(L)))):console.error("Error en la solicitud:",t.status)}catch(e){console.error("Error en la solicitud:",e)}};A();const N=document.querySelector("#template_th_student").content,w=document.querySelector("#template_th").content,j=document.querySelector("#template_th_total").content,I=document.querySelector("#template_tr").content,k=document.querySelector("#template_td").content;let $=!0;y.addEventListener("click",e=>{const t=e.target;if(t.classList.contains("edit_subject_button")){let e=prompt("Nombre de la materia",g.name);null===e||(""===e.trim()?alert("No se puede ingresar un valor vacío."):(console.log(g._id),h.querySelector(`option[data-id="${g._id}"]`).textContent=e,g.name=e,d()))}if(t.classList.contains("each_cell")){const e=t.parentElement,n=e.dataset.id,o=e.dataset.index;let c=+t.dataset.col;if(c+1>g.lastAttendedDay+1&&$){if(!window.confirm(`¿Y en la clase ${g.lastAttendedDay+1} no vino nadie?`))return;$=!1,l()}else l();function l(){t.classList.toggle("attended");let l=g.students[o];l._id!=n&&(l=g.students.find(e=>e._id==n));const r=l.attendances[c];if(1===r?l.total-=1:l.total+=1,a(l.total,q,e.querySelector(".each_total")),l.attendances[t.dataset.col]=1===r?0:1,c+1>g.lastAttendedDay&&(g.lastAttendedDay=+c+1),c+1==g.lastAttendedDay&&1==r&&!g.students.some(e=>1==e.attendances[c]))for(;c>=0;){if(g.students.some(e=>1==e.attendances[c])){g.lastAttendedDay=+c+1;break}c--}s(),d()}}if(t.classList.contains("delete_student_btn")){const e=t.closest("tr");e.classList.add("opacity_1"),document.querySelector("#th_nro_students").textContent--,m.textContent--;const n=e.dataset.id,a=+e.dataset.index;g.students.findIndex(e=>e._id==n);g.students.splice(a,1),s(),d(),setTimeout(()=>{e.remove();const t=document.querySelectorAll("tbody tr");for(let e=a;e<t.length;e++){const n=t[e].querySelector(".each_student_number");n.textContent=+e+1,t[e].dataset.index=+e}},150)}"create_student_btn"===t.id&&o(),"import_students"===t.id&&(console.log(S),S.style.display="block"),t.id,"addClass"==t.id&&(i.value++,n(+i.value)),"removeClass"==t.id&&n(--i.value)}),y.addEventListener("change",o=>{const l=o.target;if("select_area"==l.id)if("newSubjectOption"==l.value){let n=prompt("Escribe el nombre de la nueva materia");if(null===n)h.value=C;else if(""===n.trim())window.alert("No se ha ingresado ningún valor."),h.value=C;else{const a=e(),o={_id:a,name:n,students:[],nroClasses:24,lastIdStudent:0,lastAttendedDay:0};L.subjects.push(o),g=o;const s=document.createElement("option");s.value=a,s.dataset.id=a,s.textContent=n,s.selected=!0,l.append(s),t(g,!0),v=[],b=0,f.classList.add("disabled"),p.classList.add("disabled"),d()}}else g=L.subjects.find(e=>e._id==l.value),t(g,!0),v=[],b=0,f.classList.add("disabled"),p.classList.add("disabled");if("input_n_classes"===l.id&&n(+i.value),l.classList.contains("marcar_col_input")){let e=+l.dataset.col;if(e+1>g.lastAttendedDay+1&&$){if(!window.confirm(`¿Y en la clase ${g.lastAttendedDay+1} no vino nadie?`))return void(l.checked=!1);$=!1,c()}else c();function c(){const t=document.querySelectorAll(`.each_cell[data-col="${e}"`);if(l.checked)e+1>g.lastAttendedDay&&(g.lastAttendedDay=e+1),t.forEach((t,n)=>{t.classList.add("attended");let o=g.students[n];o.attendances[e]=1,o.total++,a(o.total,q,x[n])});else if(t.forEach((t,n)=>{t.classList.remove("attended");let o=g.students[n];o.attendances[e]=0,o.total--,a(o.total,q,x[n])}),e+1==g.lastAttendedDay&&!g.students.some(t=>1==t.attendances[e]))for(;e>=0;){if(g.students.some(t=>1==t.attendances[e])){g.lastAttendedDay=+e+1;break}e--}s(),d()}}});const O=D((e,t)=>{g.students.find(e=>e._id==t).name=e,s(),d()},450);y.addEventListener("input",e=>{let t=e.target;if(t.classList.contains("student_name_input")){const e=t.value,n=t.closest("tr"),a=n.dataset.id;console.log("ejee "),O(e,a)}});document.querySelectorAll(".history_arrows").forEach(e=>{e.onclick=(t=>{e.classList.contains("past")&&l(),e.classList.contains("future")&&b<v.length-1&&c()})}),document.addEventListener("keydown",e=>{if("z"===e.key.toLowerCase()&&e.ctrlKey&&(e.preventDefault(),l()),"y"===e.key.toLowerCase()&&e.ctrlKey&&(e.preventDefault(),c()),"Enter"===e.key&&e.target.classList.contains("student_name_input")){const t=e.target.closest("tr"),n=+t.dataset.index;n+1==m.textContent&&o()}})});